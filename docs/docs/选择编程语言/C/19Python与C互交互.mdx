---
sidebar_position: 19
title: ï¼ˆç¼–å†™ä¸­ï¼‰ğŸPythonä¸Cäº’äº¤äº’
---

éå¸¸é‡è¦ï¼

## æ¦‚è¿°

Pythonä¸Cè¯­è¨€çš„äº’æ“ä½œæ˜¯é«˜æ€§èƒ½è®¡ç®—å’Œç³»ç»Ÿç¼–ç¨‹çš„å…³é”®æŠ€æœ¯ã€‚ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š

1. **ctypes** - ç›´æ¥è°ƒç”¨Cåº“
2. **Cæ‰©å±•æ¨¡å—** - ç¼–å†™Python C APIæ‰©å±•
3. **Cython** - æ··åˆPythonå’ŒCè¯­æ³•çš„ç¼–è¯‘å™¨

## ctypesé›†æˆ

### åŸºæœ¬ä½¿ç”¨

```python
from ctypes import CDLL, c_int, c_double, c_char_p

# åŠ è½½Cåº“
lib = CDLL('./mylib.so')

# å®šä¹‰å‡½æ•°åŸå‹
lib.add.argtypes = [c_int, c_int]
lib.add.restype = c_int

# è°ƒç”¨Cå‡½æ•°
result = lib.add(5, 3)
print(f"5 + 3 = {result}")
```

### ç»“æ„ä½“å¤„ç†

```c
// example.h
typedef struct {
    int x;
    int y;
    char name[50];
} Point;

extern void print_point(Point *p);
```

```python
from ctypes import Structure, c_int, c_char, CDLL

class Point(Structure):
    _fields_ = [
        ("x", c_int),
        ("y", c_int),
        ("name", c_char * 50)
    ]

lib = CDLL('./example.so')
point = Point(10, 20, b"test")
lib.print_point(point)
```

## Cæ‰©å±•æ¨¡å—å¼€å‘

### åŸºæœ¬ç»“æ„

```c
#include <Python.h>

static PyObject* add(PyObject* self, PyObject* args) {
    int a, b;
    if (!PyArg_ParseTuple(args, "ii", &a, &b)) {
        return NULL;
    }
    return PyLong_FromLong(a + b);
}

static PyMethodDef methods[] = {
    {"add", add, METH_VARARGS, "Add two numbers"},
    {NULL, NULL, 0, NULL}
};

static struct PyModuleDef module = {
    PyModuleDef_HEAD_INIT,
    "myextension",
    NULL,
    -1,
    methods
};

PyMODINIT_FUNC PyInit_myextension(void) {
    return PyModule_Create(&module);
}
```

### ç¼–è¯‘setup.py

```python
from distutils.core import setup, Extension

module = Extension(
    'myextension',
    sources=['myextension.c']
)

setup(
    name='MyExtension',
    version='1.0',
    ext_modules=[module]
)
```

## Cythonå®æˆ˜

### åŸºæœ¬è¯­æ³•

```cython
# mymodule.pyx
def add(int a, int b):
    cdef int result = a + b
    return result
```

### ç¼–è¯‘setup.py

```python
from distutils.core import setup
from Cython.Build import cythonize

setup(
    ext_modules=cythonize("mymodule.pyx")
)
```

## å†…å­˜ç®¡ç†æœ€ä½³å®è·µ

### å¼•ç”¨è®¡æ•°

```c
// æ­£ç¡®å¢åŠ å¼•ç”¨è®¡æ•°
Py_INCREF(obj);

// æ­£ç¡®å‡å°‘å¼•ç”¨è®¡æ•°
Py_DECREF(obj);

// å€Ÿç”¨å¼•ç”¨ï¼ˆä¸éœ€è¦ç®¡ç†å¼•ç”¨è®¡æ•°ï¼‰
PyObject* item = PyList_GetItem(list, index);
```

### å†…å­˜æ³„æ¼æ£€æµ‹

ä½¿ç”¨Valgrindæ£€æµ‹å†…å­˜æ³„æ¼ï¼š
```bash
valgrind --leak-check=full python script.py
```

## é”™è¯¯å¤„ç†

### Cé”™è¯¯è½¬Pythonå¼‚å¸¸

```c
static PyObject* risky_function(PyObject* self, PyObject* args) {
    // æŸäº›å¯èƒ½å¤±è´¥çš„æ“ä½œ
    if (operation_failed) {
        PyErr_SetString(PyExc_RuntimeError, "Operation failed");
        return NULL;
    }
    
    // æˆåŠŸè¿”å›
    Py_RETURN_NONE;
}
```

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### é¿å…ä¸å¿…è¦çš„è½¬æ¢

```c
// ä¸å¥½çš„åšæ³•ï¼šé¢‘ç¹åˆ›å»ºPythonå¯¹è±¡
for (int i = 0; i < 1000000; i++) {
    PyObject* num = PyLong_FromLong(i);
    // ä½¿ç”¨num
    Py_DECREF(num);
}

// å¥½çš„åšæ³•ï¼šåœ¨Cå±‚é¢å¤„ç†æ•°æ®
int result = 0;
for (int i = 0; i < 1000000; i++) {
    result += i;
}
PyObject* final = PyLong_FromLong(result);
```

## å¤šçº¿ç¨‹ä¸GIL

### é‡Šæ”¾GIL

```c
Py_BEGIN_ALLOW_THREADS
// æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆæ–‡ä»¶I/Oã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰
perform_time_consuming_operation();
Py_END_ALLOW_THREADS
```

## è°ƒè¯•æŠ€å·§

### GDBè°ƒè¯•Cæ‰©å±•

```bash
gdb --args python script.py
(gdb) break myextension.c:25
(gdb) run
```

## å¸¸è§é™·é˜±

1. **å¼•ç”¨è®¡æ•°é”™è¯¯**ï¼šå¿˜è®°INCREF/DECREF
2. **GILé—®é¢˜**ï¼šåœ¨é”™è¯¯çš„æ—¶é—´æŒæœ‰æˆ–é‡Šæ”¾GIL
3. **ç±»å‹è½¬æ¢é”™è¯¯**ï¼šé”™è¯¯çš„å‚æ•°ç±»å‹è§£æ
4. **å†…å­˜æ³„æ¼**ï¼šæœªæ­£ç¡®é‡Šæ”¾åˆ†é…çš„å†…å­˜

## å®æˆ˜æ¡ˆä¾‹

### å›¾åƒå¤„ç†æ‰©å±•

```c
// å¿«é€Ÿçš„å›¾åƒæ—‹è½¬å‡½æ•°
static PyObject* rotate_image(PyObject* self, PyObject* args) {
    PyObject* image_obj;
    double angle;
    
    if (!PyArg_ParseTuple(args, "Od", &image_obj, &angle)) {
        return NULL;
    }
    
    // è·å–å›¾åƒæ•°æ®æŒ‡é’ˆ
    Py_buffer buffer;
    if (PyObject_GetBuffer(image_obj, &buffer, PyBUF_SIMPLE) != 0) {
        return NULL;
    }
    
    // æ‰§è¡Œæ—‹è½¬æ“ä½œ
    rotate_image_data(buffer.buf, buffer.len, angle);
    
    PyBuffer_Release(&buffer);
    Py_RETURN_NONE;
}
```

## å·¥å…·é“¾æ¨è

- **ç¼–è¯‘**: GCC/Clang + distutils/setuptools
- **è°ƒè¯•**: GDB + Pythonè°ƒè¯•å™¨
- **æ€§èƒ½åˆ†æ**: perf, gprof, cProfile
- **å†…å­˜æ£€æµ‹**: Valgrind, AddressSanitizer

## æœ€ä½³å®è·µæ€»ç»“

1. ä¼˜å…ˆä½¿ç”¨Cythonï¼Œè¯­æ³•æ›´Pythonic
2. å¤æ‚é¡¹ç›®ä½¿ç”¨Cæ‰©å±•æ¨¡å—
3. ç®€å•è°ƒç”¨ä½¿ç”¨ctypes
4. å§‹ç»ˆæ³¨æ„å†…å­˜ç®¡ç†å’Œå¼•ç”¨è®¡æ•°
5. åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ­£ç¡®å¤„ç†GIL
6. ç¼–å†™å…¨é¢çš„é”™è¯¯å¤„ç†ä»£ç 
7. è¿›è¡Œå……åˆ†çš„æµ‹è¯•å’Œæ€§èƒ½åˆ†æ

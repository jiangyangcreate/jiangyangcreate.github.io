# å¹¶å‘

### multiprocessing æ¨¡å—

è¿›ç¨‹æ˜¯ç³»ç»Ÿç‹¬ç«‹å®‰æ’å’Œåˆ†é…ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ï¼‰çš„åŸºæœ¬å•ä½ï¼Œæ“ä½œç³»ç»Ÿä»¥è¿›ç¨‹ä¸ºå•ä½åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œæ“ä½œç³»ç»Ÿç®¡ç†æ‰€æœ‰è¿›ç¨‹çš„æ‰§è¡Œï¼Œä¸ºå®ƒä»¬åˆç†çš„åˆ†é…èµ„æºã€‚

ä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ macOS ä¸­çš„â€œæ´»åŠ¨ç›‘è§†å™¨â€ã€Windows ä¸­çš„â€œä»»åŠ¡ç®¡ç†å™¨â€çš„ä¸€ä¸ªæ‰§è¡Œç¨‹åºã€‚

Python æ—¢æ”¯æŒå¤šè¿›ç¨‹åˆæ”¯æŒå¤šçº¿ç¨‹ã€‚

#### å¤šè¿›ç¨‹

è¿›ç¨‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼ŒPython ä¸­çš„è¿›ç¨‹é€šä¿¡ä¸€èˆ¬ç”±è¿›ç¨‹å¯¹ Queue å®Œæˆã€‚

è¿›ç¨‹ç»•è¿‡äº†å…¨å±€è§£é‡Šå™¨é”ã€‚å› æ­¤ï¼Œå¤šè¿›ç¨‹æ¨¡å—å…è®¸ç¨‹åºå‘˜å……åˆ†åˆ©ç”¨ç‰¹å®šæœºå™¨ä¸Šçš„å¤šä¸ªå¤„ç†å™¨ã€‚å®ƒåœ¨ Unix å’Œ Windows ä¸Šéƒ½èƒ½è¿è¡Œã€‚

è¿›ç¨‹çš„æ•°é‡ç­‰äº CPU æ ¸å¿ƒçš„æ•°é‡ï¼Œè¿™æ˜¯æœ€æœ‰æ•ˆçš„ã€‚å¦‚æœæ ¸æ•°å¤ªå¤šï¼Œå°±ä¸èƒ½å……åˆ†åˆ©ç”¨æ ¸æ•°ã€‚å¦‚æœå¤ªå°‘ï¼Œä¼šé€ æˆè¿›ç¨‹åˆ‡æ¢ï¼Œå¢åŠ ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚

[multiprocessing](https://docs.python.org/zh-cn/3.10/library/multiprocessing.html?highlight=multiprocessing#module-multiprocessing):Multiprocessing Module Code Documentation

```python showLineNumbers
from multiprocessing import Pool

def f(vaule):
    x = vaule[0]
    y = vaule[1]
    return x*y

if __name__ == '__main__':
    p = Pool(16) # new 16 process pools ï¼Œ because i have 16 cpu
    print(p.map(f, [(1,1), (2,2), (3,3)])) # take in data
    p.close() # close pool

# [1, 4, 9]
```

æˆ‘ä»¬æ¥å®Œæˆ 1~100000000 æ±‚å’Œçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œå¾ªç¯è§£å†³ï¼Œæš‚æ—¶ä¹Ÿä¸è€ƒè™‘åˆ—è¡¨åˆ‡ç‰‡æ“ä½œèŠ±è´¹çš„æ—¶é—´ï¼Œåªæ˜¯æŠŠåšè¿ç®—å’Œåˆå¹¶è¿ç®—ç»“æœçš„æ—¶é—´ç»Ÿè®¡å‡ºæ¥ã€‚

```python showLineNumbers
from time import time


def main():
    total = 0
    number_list = [x for x in range(1, 100000001)]
    start = time()
    for number in number_list:
        total += number
    print(total)
    end = time()
    print('Execution time: %.3fs' % (end - start))

```

```python showLineNumbers
main()
# 5000000050000000
# Execution time: 6.798s
```

åˆ©ç”¨å¤šè¿›ç¨‹â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œ

å½“æˆ‘ä»¬å°†è¿™ä¸ªä»»åŠ¡åˆ†è§£åˆ° 8 ä¸ªè¿›ç¨‹ä¸­å»æ‰§è¡Œï¼š

```python showLineNumbers
from multiprocessing import Process, Queue
from time import time

core_num = 8


def task_handler(curr_list, result_queue):
    total = 0
    for number in curr_list:
        total += number
    result_queue.put(total)


def main():
    processes = []
    number_list = [x for x in range(1, 100000001)]
    result_queue = Queue()
    index = 0
    # å¯åŠ¨core_num(8)ä¸ªè¿›ç¨‹å°†æ•°æ®åˆ‡ç‰‡åè¿›è¡Œè¿ç®—
    index_batch = int(100000000 / core_num)
    for _ in range(core_num):
        p = Process(target=task_handler,
                    args=(number_list[index:index + index_batch], result_queue))
        index += index_batch
        processes.append(p)
        p.start()
    # å¼€å§‹è®°å½•æ‰€æœ‰è¿›ç¨‹æ‰§è¡Œå®ŒæˆèŠ±è´¹çš„æ—¶é—´
    start = time()
    for p in processes:
        p.join()
    # åˆå¹¶æ‰§è¡Œç»“æœ
    total = 0
    while not result_queue.empty():
        total += result_queue.get()
    print(total)
    end = time()
    print('Execution time: ', (end - start), 's', sep='')


if __name__ == '__main__':
    main()

```

ä»¥ä¸Šä»£ç ä¿å­˜ä¸º multi_process.py

```python showLineNumbers
!python multi_process.py
```

```python showLineNumbers
# 5000000050000000
# Execution time: 0.7936668395996094s
```

æ˜æ˜¾ï¼Œå¤šè¿›ç¨‹æ›´å¿«ã€‚

ä½¿ç”¨å¤šè¿›ç¨‹åç”±äºè·å¾—äº†æ›´å¤šçš„ CPU æ‰§è¡Œæ—¶é—´ä»¥åŠæ›´å¥½çš„åˆ©ç”¨äº† CPU çš„å¤šæ ¸ç‰¹æ€§ï¼Œæ˜æ˜¾çš„å‡å°‘äº†ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼Œè€Œä¸”è®¡ç®—é‡è¶Šå¤§æ•ˆæœè¶Šæ˜æ˜¾ã€‚

### threading æ¨¡å—

çº¿ç¨‹æ˜¯ç³»ç»Ÿè°ƒåº¦èµ„æºçš„æœ€å°å•ä½ï¼ˆCPU é€šè¿‡è®¡æ—¶å™¨æ¥åˆ‡æ¢çº¿ç¨‹ï¼‰

åœ¨ Python ä¸­ï¼ŒåŒä¸ªæ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œ

å½“ç„¶ï¼Œå¦‚æœä½ è¿è¡Œå¤§é‡çš„ I/O ä»»åŠ¡ï¼Œå¤šè¿›ç¨‹ä¾ç„¶æ˜¯æœ€å¥½çš„é€‰æ‹©

çº¿ç¨‹æ•°ç­‰äº CPU å†…æ ¸æ•°çš„ä¸¤å€æ˜¯æœ€é«˜æ•ˆçš„ã€‚

GIL æ˜¯ä¸€ä¸ªé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ Python å­—èŠ‚ç çš„äº’æ–¥é”ã€‚ä¹‹æ‰€ä»¥éœ€è¦è¿™ç§é”ï¼Œä¸»è¦æ˜¯å› ä¸º CPython çš„å†…å­˜ç®¡ç†ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

åœ¨è¿™ç§ç¯å¢ƒä¸‹ï¼ŒGIL é™åˆ¶è§£é‡Šå™¨æœ¬èº«åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œè€Œä¸”ä»»ä½• Python è§£é‡Šå™¨çº§åˆ«çš„æ“ä½œéƒ½æ˜¯åºåˆ—åŒ–çš„ï¼Œå› æ­¤ä»»ä½•æ—¶å€™éƒ½åªèƒ½æœ‰ä¸€æ¡è¯­å¥æŠ›å‡ºå¼‚å¸¸ã€‚ä¸å¼‚å¸¸ç›¸å…³çš„å…±äº«å˜é‡ä¹Ÿå› æ­¤å—åˆ°ä¿æŠ¤ã€‚

çº¿ç¨‹é—´é€šä¿¡çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†çº¿ç¨‹åŒæ­¥ï¼Œå› æ­¤çº¿ç¨‹æ²¡æœ‰åƒè¿›ç¨‹é€šä¿¡é‚£æ ·ç”¨äºæ•°æ®äº¤æ¢çš„é€šä¿¡æœºåˆ¶ã€‚

Python çš„æ ‡å‡†åº“æä¾›äº†ä¸¤ä¸ªæ¨¡å—ï¼š\_thread å’Œ threadingï¼Œ\_thread æ˜¯ä½çº§æ¨¡å—ï¼Œthreading æ˜¯é«˜çº§æ¨¡å—ï¼Œå¯¹\_thread è¿›è¡Œäº†å°è£…ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ threading è¿™ä¸ªé«˜çº§æ¨¡å—ã€‚

[threading](https://docs.python.org/zh-cn/3.10/library/threading.html?highlight=threading#module-threading):Threading Multiprocessing Module Code Documentation

#### å¤šçº¿ç¨‹

```python showLineNumbers

import time
import threading


def test_thread(para='hi', sleep=3):
    time.sleep(sleep)
    print(para)


def main():
    # create thread
    thread_hi = threading.Thread(target=test_thread)
    thread_hello = threading.Thread(target=test_thread, args=('hello', 1))
    # run thread
    thread_hi.start()
    thread_hello.start()
    print('Main thread has ended!')


if __name__ == '__main__':
    main()

```

å¦‚ä¸‹æ‰€ç¤ºçš„ç•Œé¢ä¸­ï¼Œæœ‰â€œä¸‹è½½â€å’Œâ€œå…³äºâ€ä¸¤ä¸ªæŒ‰é’®ï¼Œç”¨ä¼‘çœ çš„æ–¹å¼æ¨¡æ‹Ÿç‚¹å‡»â€œä¸‹è½½â€æŒ‰é’®ä¼šè”ç½‘ä¸‹è½½æ–‡ä»¶éœ€è¦è€—è´¹ 10 ç§’çš„æ—¶é—´ï¼Œå½“ç‚¹å‡»â€œä¸‹è½½â€æŒ‰é’®åï¼Œæ•´ä¸ªä»»åŠ¡é˜»å¡ï¼š

```python showLineNumbers
import time
import tkinter
import tkinter.messagebox


def download():
    # æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡éœ€è¦èŠ±è´¹5ç§’é’Ÿæ—¶é—´
    time.sleep(5)
    tkinter.messagebox.showinfo('æç¤º', 'ä¸‹è½½å®Œæˆ!')


def show_about():
    tkinter.messagebox.showinfo('å…³äº', 'ä½œè€…: 123(v1.0)')


def main():
    top = tkinter.Tk()
    top.title('å•çº¿ç¨‹')
    top.geometry('400x400')
    top.wm_attributes('-topmost', True)

    panel = tkinter.Frame(top)
    button1 = tkinter.Button(panel, text='ä¸‹è½½', command=download)
    button1.pack(side='left')
    button2 = tkinter.Button(panel, text='å…³äº', command=show_about)
    button2.pack(side='right')
    panel.pack(side='bottom')

    tkinter.mainloop()


if __name__ == '__main__':
    main()
```

ä½¿ç”¨å¤šçº¿ç¨‹åï¼Œä¸ä¼šé˜»å¡äº†ä¸»çº¿ç¨‹ï¼š

```python showLineNumbers
import time
import tkinter
import tkinter.messagebox
from threading import Thread


def main():

    class DownloadTaskHandler(Thread):

        def run(self):
            time.sleep(5)
            tkinter.messagebox.showinfo('æç¤º', 'ä¸‹è½½å®Œæˆ!')
            # å¯ç”¨ä¸‹è½½æŒ‰é’®
            button1.config(state=tkinter.NORMAL)

    def download():
        # ç¦ç”¨ä¸‹è½½æŒ‰é’®
        button1.config(state=tkinter.DISABLED)
        # é€šè¿‡daemonå‚æ•°å°†çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹(ä¸»ç¨‹åºé€€å‡ºå°±ä¸å†ä¿ç•™æ‰§è¡Œ)
        # åœ¨çº¿ç¨‹ä¸­å¤„ç†è€—æ—¶é—´çš„ä¸‹è½½ä»»åŠ¡
        DownloadTaskHandler(daemon=True).start()

    def show_about():
        tkinter.messagebox.showinfo('å…³äº', 'ä½œè€…: 123(v1.0)')

    top = tkinter.Tk()
    top.title('å¤šçº¿ç¨‹')
    top.geometry('400x400')
    top.wm_attributes('-topmost', 1)

    panel = tkinter.Frame(top)
    button1 = tkinter.Button(panel, text='ä¸‹è½½', command=download)
    button1.pack(side='left')
    button2 = tkinter.Button(panel, text='å…³äº', command=show_about)
    button2.pack(side='right')
    panel.pack(side='bottom')

    tkinter.mainloop()


if __name__ == '__main__':
    main()
```

ä¼šçœ‹åˆ°å¼¹å‡ºçš„çª—å£æ˜¯å¤šæ¨¡æ€çš„ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ä¸å½±å“å…¶ä»–æŒ‰é’®æ“ä½œã€‚

**Python çš„å¤šçº¿ç¨‹å¹¶ä¸èƒ½å‘æŒ¥ CPU çš„å¤šæ ¸ç‰¹æ€§**ï¼Œè¿™ä¸€ç‚¹åªè¦å¯åŠ¨å‡ ä¸ªæ‰§è¡Œæ­»å¾ªç¯çš„çº¿ç¨‹å°±å¯ä»¥å¾—åˆ°è¯å®äº†ã€‚ä¹‹æ‰€ä»¥å¦‚æ­¤ï¼Œæ˜¯å› ä¸º Python çš„è§£é‡Šå™¨æœ‰ä¸€ä¸ªâ€œå…¨å±€è§£é‡Šå™¨é”â€ï¼ˆGILï¼‰çš„ä¸œè¥¿ï¼Œä»»ä½•çº¿ç¨‹æ‰§è¡Œå‰å¿…é¡»å…ˆè·å¾— GIL é”ï¼Œç„¶åæ¯æ‰§è¡Œ 100 æ¡å­—èŠ‚ç ï¼Œè§£é‡Šå™¨å°±è‡ªåŠ¨é‡Šæ”¾ GIL é”ï¼Œè®©åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ä¸ªå†å²é—ç•™é—®é¢˜ã€‚

Python è§£é‡Šå™¨ç”±äºè®¾è®¡æ—¶æœ‰ GIL å…¨å±€é”ï¼Œå¯¼è‡´äº†å¤šçº¿ç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸ã€‚å¤šçº¿ç¨‹çš„å¹¶å‘åœ¨ Python ä¸­å°±æ˜¯ä¸€ä¸ªç¾ä¸½çš„æ¢¦ã€‚

å¤šè¿›ç¨‹æ˜¯æœ‰æ•ˆçš„ã€‚

### asyncio æ¨¡å—

åç¨‹æ˜¯ç¼–å†™å¹¶å‘ä»£ç çš„åº“ï¼Œæ˜¯æ„å»º IO å¯†é›†å‹å’Œé«˜çº§ç»“æ„åŒ–ç½‘ç»œä»£ç çš„æœ€ä½³é€‰æ‹©ã€‚

ä¾‹ç¨‹çš„è¿è¡Œæ–¹å¼æ˜¯é€šè¿‡ä»£ç ä¸»åŠ¨åˆ‡æ¢çŠ¶æ€å¹¶ç­‰å¾…å¤„ç†ï¼Œå› æ­¤æ•ˆç‡æ›´é«˜ï¼Œè¯­æ³•ä¹Ÿæ›´è¯¦ç»†ã€‚å¾ªç¯å¯¹è±¡éœ€è¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼šåˆ›å»ºã€è®¾ç½®ã€æäº¤ã€ç­‰å¾…è¿è¡Œå’Œåœæ­¢ã€‚

ä¾‹è¡Œç¨‹åºçš„æœ€ä½³æ•°é‡å–å†³äºå†…å­˜ä½¿ç”¨æƒ…å†µã€‚

asyncio æ¨¡å—åŒ…å«äº†ä¸€äº›å·¥å…·ï¼Œç”¨äºç¼–å†™å¼‚æ­¥ä»£ç ã€‚

åç¨‹çš„å·¥ä½œåŸç†æ˜¯äº‹ä»¶å¾ªç¯ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå®ƒç­‰å¾…äº‹ä»¶å¹¶æ‰§è¡Œå®ƒä»¬ã€‚

æ¯æ¬¡ä»»åŠ¡ä¼šè¢«æŒ‚èµ·è‡³äº‹ä»¶å¾ªç¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰é¡ºåºæ‰§è¡Œã€‚

await å…³é”®å­—ç”¨äºæŒ‚èµ·åç¨‹ï¼Œç›´åˆ°å®ƒè¢«è°ƒç”¨ã€‚

async å…³é”®å­—ç”¨äºå®šä¹‰åç¨‹ã€‚

asyncio æ¨¡å—ç”¨äºå®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚

[asyncio](https://docs.python.org/zh-cn/3.10/library/asyncio.html?highlight=asyncio#module-asyncio):asyncio Multiprocessing Module Code Documentation

```python showLineNumbers
import asyncio

class TestA:
    def __init__(self,loop) -> None:
        self.loop = loop
        asyncio.set_event_loop(loop=self.loop) # step 3.1

    async def run_page(self,tid): # step 7
        print(tid)
        # æ­¤å¤„ç¼–å†™çˆ¬è™«ä»£ç 
        return tid

    async def close(self,):
        for i in asyncio.all_tasks(): # step 9.1
            i.cancel()
        self.loop.stop() # step  9.2


def test():
    get_async_loop = asyncio.new_event_loop() # step 1
    asyncio.set_event_loop(get_async_loop) # step 2

    async def spider(task_obj):
        async_task =  [asyncio.ensure_future(task_obj.run_page(1)),
                    asyncio.ensure_future(task_obj.run_page(2)),] # step  6
        await asyncio.wait(async_task) # step  8

        await task_obj.close() # step 9

    task_obj = TestA(get_async_loop) #step 3
    asyncio.run_coroutine_threadsafe(spider(task_obj), loop=get_async_loop) #step  4
    get_async_loop.run_forever() # step 5

test()
```

ç”Ÿæˆå™¨å‡½æ•°ä¸åç¨‹ï¼ˆæ³¨ï¼šå‡½æ•°ï¼‰éå¸¸ç›¸ä¼¼ï¼Œå®ƒä»¬ yield å¤šæ¬¡ï¼Œå®ƒä»¬å…·æœ‰å¤šä¸ªå…¥å£ç‚¹ï¼Œå¹¶ä¸”å®ƒä»¬çš„æ‰§è¡Œå¯ä»¥è¢«æŒ‚èµ·ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ç”Ÿæˆå™¨å‡½æ•°ä¸èƒ½æ§åˆ¶åœ¨å®ƒåœ¨ yield åäº¤ç»™å“ªé‡Œç»§ç»­æ‰§è¡Œï¼Œæ§åˆ¶æƒæ€»æ˜¯è½¬ç§»åˆ°ç”Ÿæˆå™¨çš„è°ƒç”¨è€…

åœ¨ Python åˆ›å»ºåç¨‹æ—¶ï¼Œtask æ˜¯ future çš„å­ç±»ï¼Œæ‰€ä»¥ task ç»§æ‰¿äº† future çš„å±æ€§å’Œæ–¹æ³•ã€‚å‡ ä¹æ²¡æœ‰ä¸åŒã€‚



### ğŸš§queue æ¨¡å—

### ğŸš§concurrent æ¨¡å—


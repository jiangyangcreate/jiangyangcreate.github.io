"use strict";(self.webpackChunkjiangmiemie=self.webpackChunkjiangmiemie||[]).push([[8342],{30449:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>o});const l=JSON.parse('{"id":"\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C/19Python\u4e0eC\u4e92\u4ea4\u4e92","title":"\uff08\u7f16\u5199\u4e2d\uff09\ud83d\udc0fPython\u4e0eC\u4e92\u4ea4\u4e92","description":"\u975e\u5e38\u91cd\u8981\uff01","source":"@site/docs/docs/\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C/19Python\u4e0eC\u4e92\u4ea4\u4e92.mdx","sourceDirName":"\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C","slug":"/\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C/19Python\u4e0eC\u4e92\u4ea4\u4e92","permalink":"/docs/\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C/19Python\u4e0eC\u4e92\u4ea4\u4e92","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":19,"frontMatter":{"sidebar_position":19,"title":"\uff08\u7f16\u5199\u4e2d\uff09\ud83d\udc0fPython\u4e0eC\u4e92\u4ea4\u4e92"},"sidebar":"tutorialSidebar","previous":{"title":"\uff08\u7f16\u5199\u4e2d\uff09\ud83d\udc0f\u7f51\u7edc\u7f16\u7a0b","permalink":"/docs/\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/C/18\u7f51\u7edc\u7f16\u7a0b"},"next":{"title":"Python\u57fa\u7840","permalink":"/docs/\u9009\u62e9\u7f16\u7a0b\u8bed\u8a00/Python/"}}');var s=i(74848),t=i(28453);const r={sidebar_position:19,title:"\uff08\u7f16\u5199\u4e2d\uff09\ud83d\udc0fPython\u4e0eC\u4e92\u4ea4\u4e92"},d=void 0,c={},o=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"ctypes\u96c6\u6210",id:"ctypes\u96c6\u6210",level:2},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:3},{value:"\u7ed3\u6784\u4f53\u5904\u7406",id:"\u7ed3\u6784\u4f53\u5904\u7406",level:3},{value:"C\u6269\u5c55\u6a21\u5757\u5f00\u53d1",id:"c\u6269\u5c55\u6a21\u5757\u5f00\u53d1",level:2},{value:"\u57fa\u672c\u7ed3\u6784",id:"\u57fa\u672c\u7ed3\u6784",level:3},{value:"\u7f16\u8bd1setup.py",id:"\u7f16\u8bd1setuppy",level:3},{value:"Cython\u5b9e\u6218",id:"cython\u5b9e\u6218",level:2},{value:"\u57fa\u672c\u8bed\u6cd5",id:"\u57fa\u672c\u8bed\u6cd5",level:3},{value:"\u7f16\u8bd1setup.py",id:"\u7f16\u8bd1setuppy-1",level:3},{value:"\u5185\u5b58\u7ba1\u7406\u6700\u4f73\u5b9e\u8df5",id:"\u5185\u5b58\u7ba1\u7406\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u5f15\u7528\u8ba1\u6570",id:"\u5f15\u7528\u8ba1\u6570",level:3},{value:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b",id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"C\u9519\u8bef\u8f6cPython\u5f02\u5e38",id:"c\u9519\u8bef\u8f6cpython\u5f02\u5e38",level:3},{value:"\u6027\u80fd\u4f18\u5316\u6280\u5de7",id:"\u6027\u80fd\u4f18\u5316\u6280\u5de7",level:2},{value:"\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8f6c\u6362",id:"\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8f6c\u6362",level:3},{value:"\u591a\u7ebf\u7a0b\u4e0eGIL",id:"\u591a\u7ebf\u7a0b\u4e0egil",level:2},{value:"\u91ca\u653eGIL",id:"\u91ca\u653egil",level:3},{value:"\u8c03\u8bd5\u6280\u5de7",id:"\u8c03\u8bd5\u6280\u5de7",level:2},{value:"GDB\u8c03\u8bd5C\u6269\u5c55",id:"gdb\u8c03\u8bd5c\u6269\u5c55",level:3},{value:"\u5e38\u89c1\u9677\u9631",id:"\u5e38\u89c1\u9677\u9631",level:2},{value:"\u5b9e\u6218\u6848\u4f8b",id:"\u5b9e\u6218\u6848\u4f8b",level:2},{value:"\u56fe\u50cf\u5904\u7406\u6269\u5c55",id:"\u56fe\u50cf\u5904\u7406\u6269\u5c55",level:3},{value:"\u5de5\u5177\u94fe\u63a8\u8350",id:"\u5de5\u5177\u94fe\u63a8\u8350",level:2},{value:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3",id:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3",level:2}];function a(n){const e={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"\u975e\u5e38\u91cd\u8981\uff01"}),"\n",(0,s.jsx)(e.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,s.jsx)(e.p,{children:"Python\u4e0eC\u8bed\u8a00\u7684\u4e92\u64cd\u4f5c\u662f\u9ad8\u6027\u80fd\u8ba1\u7b97\u548c\u7cfb\u7edf\u7f16\u7a0b\u7684\u5173\u952e\u6280\u672f\u3002\u4e3b\u8981\u6709\u4e09\u79cd\u65b9\u5f0f\uff1a"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"ctypes"})," - \u76f4\u63a5\u8c03\u7528C\u5e93"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"C\u6269\u5c55\u6a21\u5757"})," - \u7f16\u5199Python C API\u6269\u5c55"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Cython"})," - \u6df7\u5408Python\u548cC\u8bed\u6cd5\u7684\u7f16\u8bd1\u5668"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"ctypes\u96c6\u6210",children:"ctypes\u96c6\u6210"}),"\n",(0,s.jsx)(e.h3,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"from ctypes import CDLL, c_int, c_double, c_char_p\n\n# \u52a0\u8f7dC\u5e93\nlib = CDLL('./mylib.so')\n\n# \u5b9a\u4e49\u51fd\u6570\u539f\u578b\nlib.add.argtypes = [c_int, c_int]\nlib.add.restype = c_int\n\n# \u8c03\u7528C\u51fd\u6570\nresult = lib.add(5, 3)\nprint(f\"5 + 3 = {result}\")\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u7ed3\u6784\u4f53\u5904\u7406",children:"\u7ed3\u6784\u4f53\u5904\u7406"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"// example.h\ntypedef struct {\n    int x;\n    int y;\n    char name[50];\n} Point;\n\nextern void print_point(Point *p);\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'from ctypes import Structure, c_int, c_char, CDLL\n\nclass Point(Structure):\n    _fields_ = [\n        ("x", c_int),\n        ("y", c_int),\n        ("name", c_char * 50)\n    ]\n\nlib = CDLL(\'./example.so\')\npoint = Point(10, 20, b"test")\nlib.print_point(point)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"c\u6269\u5c55\u6a21\u5757\u5f00\u53d1",children:"C\u6269\u5c55\u6a21\u5757\u5f00\u53d1"}),"\n",(0,s.jsx)(e.h3,{id:"\u57fa\u672c\u7ed3\u6784",children:"\u57fa\u672c\u7ed3\u6784"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:'#include <Python.h>\n\nstatic PyObject* add(PyObject* self, PyObject* args) {\n    int a, b;\n    if (!PyArg_ParseTuple(args, "ii", &a, &b)) {\n        return NULL;\n    }\n    return PyLong_FromLong(a + b);\n}\n\nstatic PyMethodDef methods[] = {\n    {"add", add, METH_VARARGS, "Add two numbers"},\n    {NULL, NULL, 0, NULL}\n};\n\nstatic struct PyModuleDef module = {\n    PyModuleDef_HEAD_INIT,\n    "myextension",\n    NULL,\n    -1,\n    methods\n};\n\nPyMODINIT_FUNC PyInit_myextension(void) {\n    return PyModule_Create(&module);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u7f16\u8bd1setuppy",children:"\u7f16\u8bd1setup.py"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"from distutils.core import setup, Extension\n\nmodule = Extension(\n    'myextension',\n    sources=['myextension.c']\n)\n\nsetup(\n    name='MyExtension',\n    version='1.0',\n    ext_modules=[module]\n)\n"})}),"\n",(0,s.jsx)(e.h2,{id:"cython\u5b9e\u6218",children:"Cython\u5b9e\u6218"}),"\n",(0,s.jsx)(e.h3,{id:"\u57fa\u672c\u8bed\u6cd5",children:"\u57fa\u672c\u8bed\u6cd5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-cython",children:"# mymodule.pyx\ndef add(int a, int b):\n    cdef int result = a + b\n    return result\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u7f16\u8bd1setuppy-1",children:"\u7f16\u8bd1setup.py"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:'from distutils.core import setup\nfrom Cython.Build import cythonize\n\nsetup(\n    ext_modules=cythonize("mymodule.pyx")\n)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5185\u5b58\u7ba1\u7406\u6700\u4f73\u5b9e\u8df5",children:"\u5185\u5b58\u7ba1\u7406\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(e.h3,{id:"\u5f15\u7528\u8ba1\u6570",children:"\u5f15\u7528\u8ba1\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"// \u6b63\u786e\u589e\u52a0\u5f15\u7528\u8ba1\u6570\nPy_INCREF(obj);\n\n// \u6b63\u786e\u51cf\u5c11\u5f15\u7528\u8ba1\u6570\nPy_DECREF(obj);\n\n// \u501f\u7528\u5f15\u7528\uff08\u4e0d\u9700\u8981\u7ba1\u7406\u5f15\u7528\u8ba1\u6570\uff09\nPyObject* item = PyList_GetItem(list, index);\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b",children:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b"}),"\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528Valgrind\u68c0\u6d4b\u5185\u5b58\u6cc4\u6f0f\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"valgrind --leak-check=full python script.py\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,s.jsx)(e.h3,{id:"c\u9519\u8bef\u8f6cpython\u5f02\u5e38",children:"C\u9519\u8bef\u8f6cPython\u5f02\u5e38"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:'static PyObject* risky_function(PyObject* self, PyObject* args) {\n    // \u67d0\u4e9b\u53ef\u80fd\u5931\u8d25\u7684\u64cd\u4f5c\n    if (operation_failed) {\n        PyErr_SetString(PyExc_RuntimeError, "Operation failed");\n        return NULL;\n    }\n    \n    // \u6210\u529f\u8fd4\u56de\n    Py_RETURN_NONE;\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u6027\u80fd\u4f18\u5316\u6280\u5de7",children:"\u6027\u80fd\u4f18\u5316\u6280\u5de7"}),"\n",(0,s.jsx)(e.h3,{id:"\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8f6c\u6362",children:"\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u8f6c\u6362"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"// \u4e0d\u597d\u7684\u505a\u6cd5\uff1a\u9891\u7e41\u521b\u5efaPython\u5bf9\u8c61\nfor (int i = 0; i < 1000000; i++) {\n    PyObject* num = PyLong_FromLong(i);\n    // \u4f7f\u7528num\n    Py_DECREF(num);\n}\n\n// \u597d\u7684\u505a\u6cd5\uff1a\u5728C\u5c42\u9762\u5904\u7406\u6570\u636e\nint result = 0;\nfor (int i = 0; i < 1000000; i++) {\n    result += i;\n}\nPyObject* final = PyLong_FromLong(result);\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u591a\u7ebf\u7a0b\u4e0egil",children:"\u591a\u7ebf\u7a0b\u4e0eGIL"}),"\n",(0,s.jsx)(e.h3,{id:"\u91ca\u653egil",children:"\u91ca\u653eGIL"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:"Py_BEGIN_ALLOW_THREADS\n// \u6267\u884c\u8017\u65f6\u64cd\u4f5c\uff08\u6587\u4ef6I/O\u3001\u7f51\u7edc\u8bf7\u6c42\u7b49\uff09\nperform_time_consuming_operation();\nPy_END_ALLOW_THREADS\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u8c03\u8bd5\u6280\u5de7",children:"\u8c03\u8bd5\u6280\u5de7"}),"\n",(0,s.jsx)(e.h3,{id:"gdb\u8c03\u8bd5c\u6269\u5c55",children:"GDB\u8c03\u8bd5C\u6269\u5c55"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"gdb --args python script.py\n(gdb) break myextension.c:25\n(gdb) run\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5e38\u89c1\u9677\u9631",children:"\u5e38\u89c1\u9677\u9631"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5f15\u7528\u8ba1\u6570\u9519\u8bef"}),"\uff1a\u5fd8\u8bb0INCREF/DECREF"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"GIL\u95ee\u9898"}),"\uff1a\u5728\u9519\u8bef\u7684\u65f6\u95f4\u6301\u6709\u6216\u91ca\u653eGIL"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u7c7b\u578b\u8f6c\u6362\u9519\u8bef"}),"\uff1a\u9519\u8bef\u7684\u53c2\u6570\u7c7b\u578b\u89e3\u6790"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5185\u5b58\u6cc4\u6f0f"}),"\uff1a\u672a\u6b63\u786e\u91ca\u653e\u5206\u914d\u7684\u5185\u5b58"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u5b9e\u6218\u6848\u4f8b",children:"\u5b9e\u6218\u6848\u4f8b"}),"\n",(0,s.jsx)(e.h3,{id:"\u56fe\u50cf\u5904\u7406\u6269\u5c55",children:"\u56fe\u50cf\u5904\u7406\u6269\u5c55"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-c",children:'// \u5feb\u901f\u7684\u56fe\u50cf\u65cb\u8f6c\u51fd\u6570\nstatic PyObject* rotate_image(PyObject* self, PyObject* args) {\n    PyObject* image_obj;\n    double angle;\n    \n    if (!PyArg_ParseTuple(args, "Od", &image_obj, &angle)) {\n        return NULL;\n    }\n    \n    // \u83b7\u53d6\u56fe\u50cf\u6570\u636e\u6307\u9488\n    Py_buffer buffer;\n    if (PyObject_GetBuffer(image_obj, &buffer, PyBUF_SIMPLE) != 0) {\n        return NULL;\n    }\n    \n    // \u6267\u884c\u65cb\u8f6c\u64cd\u4f5c\n    rotate_image_data(buffer.buf, buffer.len, angle);\n    \n    PyBuffer_Release(&buffer);\n    Py_RETURN_NONE;\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5de5\u5177\u94fe\u63a8\u8350",children:"\u5de5\u5177\u94fe\u63a8\u8350"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u7f16\u8bd1"}),": GCC/Clang + distutils/setuptools"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u8c03\u8bd5"}),": GDB + Python\u8c03\u8bd5\u5668"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u6027\u80fd\u5206\u6790"}),": perf, gprof, cProfile"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5185\u5b58\u68c0\u6d4b"}),": Valgrind, AddressSanitizer"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3",children:"\u6700\u4f73\u5b9e\u8df5\u603b\u7ed3"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u4f18\u5148\u4f7f\u7528Cython\uff0c\u8bed\u6cd5\u66f4Pythonic"}),"\n",(0,s.jsx)(e.li,{children:"\u590d\u6742\u9879\u76ee\u4f7f\u7528C\u6269\u5c55\u6a21\u5757"}),"\n",(0,s.jsx)(e.li,{children:"\u7b80\u5355\u8c03\u7528\u4f7f\u7528ctypes"}),"\n",(0,s.jsx)(e.li,{children:"\u59cb\u7ec8\u6ce8\u610f\u5185\u5b58\u7ba1\u7406\u548c\u5f15\u7528\u8ba1\u6570"}),"\n",(0,s.jsx)(e.li,{children:"\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\u6b63\u786e\u5904\u7406GIL"}),"\n",(0,s.jsx)(e.li,{children:"\u7f16\u5199\u5168\u9762\u7684\u9519\u8bef\u5904\u7406\u4ee3\u7801"}),"\n",(0,s.jsx)(e.li,{children:"\u8fdb\u884c\u5145\u5206\u7684\u6d4b\u8bd5\u548c\u6027\u80fd\u5206\u6790"}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}},28453:(n,e,i)=>{i.d(e,{R:()=>r,x:()=>d});var l=i(96540);const s={},t=l.createContext(s);function r(n){const e=l.useContext(t);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),l.createElement(t.Provider,{value:e},n.children)}}}]);
"use strict";(self.webpackChunkjiangmiemie=self.webpackChunkjiangmiemie||[]).push([[5773],{23659:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1/asyncio","title":"asyncio","description":"asyncio \u6a21\u5757","source":"@site/docs/docs/Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1/asyncio.mdx","sourceDirName":"Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1","slug":"/Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1/asyncio","permalink":"/docs/Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1/asyncio","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"asyncio"},"sidebar":"tutorialSidebar","previous":{"title":"socket","permalink":"/docs/Python\u6807\u51c6\u5e93/13\u7f51\u7edc\u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1/socket"},"next":{"title":"\u4e92\u8054\u7f51\u6570\u636e\u5904\u7406","permalink":"/docs/Python\u6807\u51c6\u5e93/14\u4e92\u8054\u7f51\u6570\u636e\u5904\u7406/"}}');var i=s(74848),a=s(28453);const o={sidebar_position:3,title:"asyncio"},r=void 0,c={},l=[{value:"asyncio \u6a21\u5757",id:"asyncio-\u6a21\u5757",level:2},{value:"asyncio.gather()",id:"asynciogather",level:3},{value:"asyncio.create_task()",id:"asynciocreate_task",level:3},{value:"\u793a\u4f8b\u4ee3\u7801",id:"\u793a\u4f8b\u4ee3\u7801",level:3}];function d(n){const e={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h2,{id:"asyncio-\u6a21\u5757",children:"asyncio \u6a21\u5757"}),"\n",(0,i.jsx)(e.p,{children:"\u534f\u7a0b\u662f\u7f16\u5199\u5e76\u53d1\u4ee3\u7801\u7684\u5e93\uff0c\u662f\u6784\u5efa IO \u5bc6\u96c6\u578b\u548c\u9ad8\u7ea7\u7ed3\u6784\u5316\u7f51\u7edc\u4ee3\u7801\u7684\u6700\u4f73\u9009\u62e9\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4f8b\u7a0b\u7684\u8fd0\u884c\u65b9\u5f0f\u662f\u901a\u8fc7\u4ee3\u7801\u4e3b\u52a8\u5207\u6362\u72b6\u6001\u5e76\u7b49\u5f85\u5904\u7406\uff0c\u56e0\u6b64\u6548\u7387\u66f4\u9ad8\uff0c\u8bed\u6cd5\u4e5f\u66f4\u8be6\u7ec6\u3002\u5faa\u73af\u5bf9\u8c61\u9700\u8981\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\uff1a\u521b\u5efa\u3001\u8bbe\u7f6e\u3001\u63d0\u4ea4\u3001\u7b49\u5f85\u8fd0\u884c\u548c\u505c\u6b62\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4f8b\u884c\u7a0b\u5e8f\u7684\u6700\u4f73\u6570\u91cf\u53d6\u51b3\u4e8e\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\u3002"}),"\n",(0,i.jsx)(e.p,{children:"asyncio \u6a21\u5757\u5305\u542b\u4e86\u4e00\u4e9b\u5de5\u5177\uff0c\u7528\u4e8e\u7f16\u5199\u5f02\u6b65\u4ee3\u7801\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u534f\u7a0b\u7684\u5de5\u4f5c\u539f\u7406\u662f\u4e8b\u4ef6\u5faa\u73af\uff0c\u4e8b\u4ef6\u5faa\u73af\u662f\u4e00\u4e2a\u65e0\u9650\u5faa\u73af\uff0c\u5b83\u7b49\u5f85\u4e8b\u4ef6\u5e76\u6267\u884c\u5b83\u4eec\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u6bcf\u6b21\u4efb\u52a1\u4f1a\u88ab\u6302\u8d77\u81f3\u4e8b\u4ef6\u5faa\u73af\u961f\u5217\u4e2d\uff0c\u7136\u540e\u6309\u987a\u5e8f\u6267\u884c\u3002"}),"\n",(0,i.jsx)(e.p,{children:"await \u5173\u952e\u5b57\u7528\u4e8e\u6302\u8d77\u534f\u7a0b\uff0c\u5982\u679c\u963b\u585e\uff0c\u5c31\u628aCPU\u8d76\u8d70\uff0c\u76f4\u5230\u88ab\u4e8b\u4ef6\u5faa\u73af\u518d\u6b21\u8c03\u7528\u3002"}),"\n",(0,i.jsx)(e.p,{children:"async \u5173\u952e\u5b57\u7528\u4e8e\u5b9a\u4e49\u534f\u7a0b\u3002"}),"\n",(0,i.jsx)(e.p,{children:"asyncio \u6a21\u5757\u7528\u4e8e\u5b9e\u73b0\u5f02\u6b65\u7f16\u7a0b\u3002"}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.a,{href:"https://docs.python.org/3.14/library/asyncio.html#module-asyncio",children:"asyncio"}),":asyncio"," Multiprocessing Module Code Documentation"]}),"\n",(0,i.jsx)(e.p,{children:"\u4e00\u4e9b\u5e38\u7528\u51fd\u6570\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",metastring:"showLineNumbers",children:'import asyncio\n\nasync def demo_asyncio_functions():\n    # 1. asyncio.sleep() - \u5f02\u6b65\u7761\u7720\n    await asyncio.sleep(1)\n\n    # 2. asyncio.wait_for() - \u8bbe\u7f6e\u8d85\u65f6\n    try:\n        result = await asyncio.wait_for(\n            asyncio.sleep(5),\n            timeout=2.0\n        )\n    except asyncio.TimeoutError:\n        print("\u64cd\u4f5c\u8d85\u65f6")\n    \n    # 3. asyncio.as_completed() - \u6309\u5b8c\u6210\u987a\u5e8f\u83b7\u53d6\u7ed3\u679c\n    tasks = [\n        asyncio.create_task(asyncio.sleep(2, result="\u6162\u4efb\u52a1")),\n        asyncio.create_task(asyncio.sleep(1, result="\u5feb\u4efb\u52a1"))\n    ]\n    for coro in asyncio.as_completed(tasks):\n        result = await coro\n        print(f"\u5b8c\u6210: {result}")\n    # \u8f93\u51fa\u987a\u5e8f: \u5feb\u4efb\u52a1, \u6162\u4efb\u52a1\n\nasyncio.run(demo_asyncio_functions())\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u751f\u6210\u5668\u51fd\u6570\u4e0e\u534f\u7a0b\uff08\u6ce8\uff1a\u51fd\u6570\uff09\u975e\u5e38\u76f8\u4f3c\uff0c\u5b83\u4eec yield \u591a\u6b21\uff0c\u5b83\u4eec\u5177\u6709\u591a\u4e2a\u5165\u53e3\u70b9\uff0c\u5e76\u4e14\u5b83\u4eec\u7684\u6267\u884c\u53ef\u4ee5\u88ab\u6302\u8d77\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\u751f\u6210\u5668\u51fd\u6570\u4e0d\u80fd\u63a7\u5236\u5728\u5b83\u5728 yield \u540e\u4ea4\u7ed9\u54ea\u91cc\u7ee7\u7eed\u6267\u884c\uff0c\u63a7\u5236\u6743\u603b\u662f\u8f6c\u79fb\u5230\u751f\u6210\u5668\u7684\u8c03\u7528\u8005"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 Python \u521b\u5efa\u534f\u7a0b\u65f6\uff0ctask \u662f future \u7684\u5b50\u7c7b\uff0c\u6240\u4ee5 task \u7ee7\u627f\u4e86 future \u7684\u5c5e\u6027\u548c\u65b9\u6cd5\u3002\u51e0\u4e4e\u6ca1\u6709\u4e0d\u540c\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",metastring:"showLineNumbers",children:"import asyncio\n\nclass TestA:\n    def __init__(self,loop) -> None:\n        self.loop = loop\n        asyncio.set_event_loop(loop=self.loop) # step 3.1\n\n    async def run_page(self,tid): # step 7\n        print(tid)\n        # \u6b64\u5904\u7f16\u5199\u722c\u866b\u4ee3\u7801\n        return tid\n\n    async def close(self,):\n        for i in asyncio.all_tasks(): # step 9.1\n            i.cancel()\n        self.loop.stop() # step  9.2\n\n\ndef test():\n    get_async_loop = asyncio.new_event_loop() # step 1\n    asyncio.set_event_loop(get_async_loop) # step 2\n\n    async def spider(task_obj):\n        async_task =  [asyncio.ensure_future(task_obj.run_page(1)),\n                    asyncio.ensure_future(task_obj.run_page(2)),] # step  6\n        await asyncio.wait(async_task) # step  8\n\n        await task_obj.close() # step 9\n\n    task_obj = TestA(get_async_loop) #step 3\n    asyncio.run_coroutine_threadsafe(spider(task_obj), loop=get_async_loop) #step  4\n    get_async_loop.run_forever() # step 5\n\ntest()\n"})}),"\n",(0,i.jsx)(e.h3,{id:"asynciogather",children:"asyncio.gather()"}),"\n",(0,i.jsxs)(e.p,{children:["\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"asyncio.gather()"})," \u6216 ",(0,i.jsx)(e.code,{children:"asyncio.create_task()"})," \u53ef\u4ee5\u5e76\u53d1\u6267\u884c\u591a\u4e2a\u534f\u7a0b\u3002"]}),"\n",(0,i.jsx)(e.p,{children:"\u51fd\u6570\u7b7e\u540d\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"asyncio.gather(*coros_or_futures, loop=None, return_exceptions=False) -> List[Any]"})}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u53c2\u6570\u8bf4\u660e\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"*coros_or_futures"}),"\uff1a\u534f\u7a0b\u6216 future \u5bf9\u8c61"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"loop=None"}),"\uff1a\u4e8b\u4ef6\u5faa\u73af\uff0c\u9ed8\u8ba4\u4f7f\u7528\u5f53\u524d\u4e8b\u4ef6\u5faa\u73af"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"return_exceptions=False"}),"\uff1a\u662f\u5426\u8fd4\u56de\u5f02\u5e38\uff0c\u9ed8\u8ba4\u4e0d\u8fd4\u56de"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u8fd4\u56de\u503c\u8bf4\u660e\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8fd4\u56de\u7ed3\u679c\u4e3a\u5217\u8868\uff0c\u5217\u8868\u4e2d\u5305\u542b\u6240\u6709\u534f\u7a0b\u6216 future \u5bf9\u8c61\u7684\u8fd4\u56de\u7ed3\u679c"}),"\n",(0,i.jsxs)(e.li,{children:["\u5982\u679c",(0,i.jsx)(e.code,{children:"return_exceptions=True"}),"\uff0c\u5219\u8fd4\u56de\u7ed3\u679c\u4e3a\u5217\u8868\uff0c\u5217\u8868\u4e2d\u5305\u542b\u6240\u6709\u534f\u7a0b\u6216 future \u5bf9\u8c61\u7684\u8fd4\u56de\u7ed3\u679c\uff0c\u5305\u62ec\u5f02\u5e38"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",metastring:"showLineNumbers",children:'import asyncio\nimport time\n\nasync def task(name, duration):\n    """\u6a21\u62df\u4e00\u4e2a\u5f02\u6b65\u4efb\u52a1"""\n    print(f"\u4efb\u52a1 {name} \u5f00\u59cb")\n    await asyncio.sleep(duration)\n    print(f"\u4efb\u52a1 {name} \u5b8c\u6210")\n    return f"\u7ed3\u679c-{name}"\n\nasync def main():\n    # \u65b9\u6cd51: \u4f7f\u7528 gather \u5e76\u53d1\u6267\u884c\n    start = time.time()\n    results = await asyncio.gather(\n        task("A", 2),\n        task("B", 1),\n        task("C", 3)\n    )\n    print(f"\u7ed3\u679c: {results}")\n    print(f"\u603b\u8017\u65f6: {time.time() - start:.2f}\u79d2")\n    # \u603b\u8017\u65f6\u7ea63\u79d2\uff08\u6700\u957f\u4efb\u52a1\u7684\u65f6\u95f4\uff09\uff0c\u800c\u975e6\u79d2\n\nasyncio.run(main())\n# \u8f93\u51fa:\n# \u4efb\u52a1 A \u5f00\u59cb\n# \u4efb\u52a1 B \u5f00\u59cb\n# \u4efb\u52a1 C \u5f00\u59cb\n# \u4efb\u52a1 B \u5b8c\u6210\n# \u4efb\u52a1 A \u5b8c\u6210\n# \u4efb\u52a1 C \u5b8c\u6210\n# \u7ed3\u679c: [\'\u7ed3\u679c-A\', \'\u7ed3\u679c-B\', \'\u7ed3\u679c-C\']\n# \u603b\u8017\u65f6: 3.00\u79d2\n'})}),"\n",(0,i.jsx)(e.h3,{id:"asynciocreate_task",children:"asyncio.create_task()"}),"\n",(0,i.jsxs)(e.p,{children:["\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"asyncio.gather()"})," \u6216 ",(0,i.jsx)(e.code,{children:"asyncio.create_task()"})," \u53ef\u4ee5\u5e76\u53d1\u6267\u884c\u591a\u4e2a\u534f\u7a0b\u3002"]}),"\n",(0,i.jsx)(e.p,{children:"\u51fd\u6570\u7b7e\u540d\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.code,{children:"asyncio.create_task(coro, *, name=None)"})}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u53c2\u6570\u8bf4\u660e\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"coro"}),"\uff1a\u534f\u7a0b\u5bf9\u8c61"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"name=None"}),"\uff1a\u4efb\u52a1\u540d\u79f0\uff0c\u9ed8\u8ba4\u4e0d\u8bbe\u7f6e"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u8fd4\u56de\u503c\u8bf4\u660e\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u8fd4\u56de\u7ed3\u679c\u4e3a\u4efb\u52a1\u5bf9\u8c61"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",metastring:"showLineNumbers",children:'import asyncio\nimport time\n\nasync def task(name, duration):\n    """\u6a21\u62df\u4e00\u4e2a\u5f02\u6b65\u4efb\u52a1"""\n    print(f"\u4efb\u52a1 {name} \u5f00\u59cb")\n    await asyncio.sleep(duration)\n    print(f"\u4efb\u52a1 {name} \u5b8c\u6210")\n    return f"\u7ed3\u679c-{name}"\n\nasync def main2():\n    start = time.time()\n    \n    # \u521b\u5efa\u4efb\u52a1\uff0c\u7acb\u5373\u5f00\u59cb\u6267\u884c\n    task1 = asyncio.create_task(task("X", 2))\n    task2 = asyncio.create_task(task("Y", 1))\n    task3 = asyncio.create_task(task("Z", 3))\n    \n    # \u7b49\u5f85\u6240\u6709\u4efb\u52a1\u5b8c\u6210\n    result1 = await task1\n    result2 = await task2\n    result3 = await task3\n    \n    print(f"\u7ed3\u679c: {result1}, {result2}, {result3}")\n    print(f"\u603b\u8017\u65f6: {time.time() - start:.2f}\u79d2")\n\nasyncio.run(main2())\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u793a\u4f8b\u4ee3\u7801",children:"\u793a\u4f8b\u4ee3\u7801"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",metastring:"showLineNumbers",children:'"""\n\u4e00\u4e2a\u5bb9\u91cf\u6709\u9650\u7684\u961f\u5217\uff0c\u9700\u8981\u653e\u51652\u500d\u5176\u5bb9\u91cf\u7684\u4efb\u52a1\u3002\u5047\u8bbe\u5bb9\u91cf\u4e3a2\uff0c\u4efb\u52a1\u4e3a4\u3002\n\n\u6d88\u8d39\u8005\u4fa7\u67092\u4e2a\u6d88\u8d39\u8005\u5728\u6d88\u8d39\u3002\u6d88\u8d39\u4e0e\u6dfb\u52a0\u540c\u6b65\u53d1\u751f\u3002\n\n\u5e0c\u671b\u5f53\u6240\u6709\u4efb\u52a1\uff084\u4e2a\uff09\u88ab\u6d88\u8d39\u5b8c\u6210\uff0c\u7a0b\u5e8f\u9000\u51fa\u3002\n"""\n\nimport asyncio\nimport random\n\n# \u914d\u7f6e\u53c2\u6570\nQUEUE_CAPACITY = 2\nTOTAL_TASKS = 4\nNUM_CONSUMERS = 5\n\nasync def producer(q):\n\n    for i in range(1, TOTAL_TASKS + 1):\n        print(f"[\u751f\u4ea7\u8005] \u5c1d\u8bd5\u653e\u5165\u4efb\u52a1 {i}...")\n        # \u5982\u679c\u961f\u5217\u6ee1\u4e86\uff0cput \u4f1a\u5728\u8fd9\u91cc\u6302\u8d77\uff08yield\uff09\uff0c\u76f4\u5230\u6709\u7a7a\u95f4\n        await q.put(i)\n        print(f"[\u751f\u4ea7\u8005] \u6210\u529f\u653e\u5165\u4efb\u52a1 {i}\u3002\u5f53\u524d\u961f\u5217\u5927\u5c0f: {q.qsize()}")\n    print("[\u751f\u4ea7\u8005] \u6240\u6709\u4efb\u52a1\u6295\u653e\u5b8c\u6bd5\u3002")\n\nasync def consumer(name, q):\n    while True:\n        # \u83b7\u53d6\u4efb\u52a1\uff0c\u5982\u679c\u961f\u5217\u4e3a\u7a7a\uff0c\u8fd9\u91cc\u4f1a\u6302\u8d77\n        task = await q.get()\n        print(f"    [\u6d88\u8d39\u8005 {name}] \u6b63\u5728\u5904\u7406\u4efb\u52a1 {task}...")\n        \n        # \u6a21\u62df\u5f02\u6b65 IO \u8017\u65f6\uff08\u4e0d\u4f1a\u963b\u585e\u6574\u4e2a\u4e8b\u4ef6\u5faa\u73af\uff09\n        await asyncio.sleep(random.uniform(0.5, 1.5))\n        \n        print(f"    [\u6d88\u8d39\u8005 {name}] \u5b8c\u6210\u4efb\u52a1 {task}\u3002")\n        \n        # \u6807\u8bb0\u4efb\u52a1\u5b8c\u6210\n        q.task_done()\n\nasync def main():\n    # 1. \u521b\u5efa\u6709\u9650\u5bb9\u91cf\u7684\u4efb\u52a1\u961f\u5217\n    task_queue = asyncio.Queue(maxsize=QUEUE_CAPACITY)\n\n    # 2. \u542f\u52a8\u751f\u4ea7\u8005\n    producer_task = asyncio.create_task(producer(task_queue))\n\n    # 3. \u542f\u52a8\u591a\u4e2a\u6d88\u8d39\u8005\n    consumers = [\n        asyncio.create_task(consumer(f"C-{i+1}", task_queue)) \n        for i in range(NUM_CONSUMERS)\n    ]\n\n    # 4. \u7b49\u5f85\u751f\u4ea7\u8005\u653e\u5b8c\u6240\u6709\u4e1c\u897f\n    await producer_task\n\n    # 5. \u5173\u952e\uff1a\u7b49\u5f85\u961f\u5217\u4e2d\u6240\u6709\u4efb\u52a1\u88ab task_done\n    await task_queue.join()\n    print("\\n[\u4e3b\u7a0b\u5e8f] \u6240\u6709\u4efb\u52a1\u5904\u7406\u5b8c\u6bd5\u3002")\n\n    # 6. \u4f18\u96c5\u6e05\u7406\uff1a\u53d6\u6d88\u8fd8\u5728 while True \u5faa\u73af\u4e2d\u7684\u6d88\u8d39\u8005\u534f\u7a0b\n    for c in consumers:\n        c.cancel()\n    \n    # \u7b49\u5f85\u6d88\u8d39\u8005\u534f\u7a0b\u5f7b\u5e95\u7ed3\u675f\uff08\u53ef\u9009\uff0c\u4f46\u63a8\u8350\uff09\n    await asyncio.gather(*consumers, return_exceptions=True)\n\nif __name__ == "__main__":\n    asyncio.run(main())\n'})})]})}function p(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},28453:(n,e,s)=>{s.d(e,{R:()=>o,x:()=>r});var t=s(96540);const i={},a=t.createContext(i);function o(n){const e=t.useContext(a);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);